|                                                                                            |     |                                                                                                    |                                                                                            |     |                                                                                                    |
| ------------------------------------------------------------------------------------------ | --- | -------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | --- | -------------------------------------------------------------------------------------------------- |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_1) | 1   | package mapreduce                                                                                  | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_1) | 1   | package mapreduce                                                                                  |
|                                                                                            | 2   |                                                                                                    |                                                                                            | 2   |                                                                                                    |
|                                                                                            | 3   | import (                                                                                           |                                                                                            | 3   | import (                                                                                           |
|                                                                                            | 4   | "container/list"                                                                                   |                                                                                            | 4   | "container/list"                                                                                   |
|                                                                                            | 5   | "fmt"                                                                                              |                                                                                            | 5   | "fmt"                                                                                              |
|                                                                                            | 6   | )                                                                                                  |                                                                                            | 6   | )                                                                                                  |
|                                                                                            | 7   |                                                                                                    |                                                                                            | 7   |                                                                                                    |
|                                                                                            | 8   | type WorkerInfo struct {                                                                           |                                                                                            | 8   | type WorkerInfo struct {                                                                           |
|                                                                                            | 9   | address string                                                                                     |                                                                                            | 9   | address string                                                                                     |
|                                                                                            | 10  | // You can add definitions here.                                                                   |                                                                                            | 10  | // You can add definitions here.                                                                   |
|                                                                                            | 11  | }                                                                                                  |                                                                                            | 11  | }                                                                                                  |
|                                                                                            | 12  |                                                                                                    |                                                                                            | 12  |                                                                                                    |
|                                                                                            | 13  | // Clean up all workers by sending a Shutdown RPC to each one of them Collect                      |                                                                                            | 13  | // Clean up all workers by sending a Shutdown RPC to each one of them Collect                      |
|                                                                                            | 14  | // the number of jobs each work has performed.                                                     |                                                                                            | 14  | // the number of jobs each work has performed.                                                     |
|                                                                                            | 15  | func (mr *MapReduce) KillWorkers() *list.List {                                                    |                                                                                            | 15  | func (mr *MapReduce) KillWorkers() *list.List {                                                    |
|                                                                                            | 16  | l := list.New()                                                                                    |                                                                                            | 16  | l := list.New()                                                                                    |
|                                                                                            | 17  | for _, w := range mr.Workers {                                                                     |                                                                                            | 17  | for _, w := range mr.Workers {                                                                     |
|                                                                                            | 18  | DPrintf("DoWork: shutdown %s\n", w.address)                                                        |                                                                                            | 18  | DPrintf("DoWork: shutdown %s\n", w.address)                                                        |
|                                                                                            | 19  | args := &ShutdownArgs{}                                                                            |                                                                                            | 19  | args := &ShutdownArgs{}                                                                            |
|                                                                                            | 20  | var reply ShutdownReply                                                                            |                                                                                            | 20  | var reply ShutdownReply                                                                            |
|                                                                                            | 21  | ok := call(w.address, "Worker.Shutdown", args, &reply)                                             |                                                                                            | 21  | ok := call(w.address, "Worker.Shutdown", args, &reply)                                             |
|                                                                                            | 22  | if !ok {                                                                                           |                                                                                            | 22  | if !ok {                                                                                           |
|                                                                                            | 23  | fmt.Printf("DoWork: RPC %s shutdown error\n", w.address)                                           |                                                                                            | 23  | fmt.Printf("DoWork: RPC %s shutdown error\n", w.address)                                           |
|                                                                                            | 24  | } else {                                                                                           |                                                                                            | 24  | } else {                                                                                           |
|                                                                                            | 25  | l.PushBack(reply.Njobs)                                                                            |                                                                                            | 25  | l.PushBack(reply.Njobs)                                                                            |
|                                                                                            | 26  | }                                                                                                  |                                                                                            | 26  | }                                                                                                  |
|                                                                                            | 27  | }                                                                                                  |                                                                                            | 27  | }                                                                                                  |
|                                                                                            | 28  | return l                                                                                           |                                                                                            | 28  | return l                                                                                           |
|                                                                                            | 29  | }                                                                                                  |                                                                                            | 29  | }                                                                                                  |
|                                                                                            | 30  |                                                                                                    |                                                                                            | 30  |                                                                                                    |
|                                                                                            | 31  | func (mr *MapReduce) RunMaster() *list.List {                                                      |                                                                                            | 31  | func (mr *MapReduce) RunMaster() *list.List {                                                      |
|                                                                                            | 32  | fmt.Printf("nMap: %v\nnReduce: %v\nfile: %q\n", mr.nMap, mr.nReduce, mr.file)                      |                                                                                            | 32  | fmt.Printf("nMap: %v\nnReduce: %v\nfile: %q\n", mr.nMap, mr.nReduce, mr.file)                      |
|                                                                                            | 33  |                                                                                                    |                                                                                            | 33  |                                                                                                    |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_2) | 34  | // Create channels to manage job completion and worker assignment                                  | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_2) | 34  | // Create channels to manage worker assignment                                                     |
|                                                                                            | 35  | //jobDone := make(chan bool)                                                                       |                                                                                            |     |                                                                                                    |
|                                                                                            | 36  | workerChannel := mr.registerChannel                                                                |                                                                                            | 35  | workerChannel := mr.registerChannel                                                                |
|                                                                                            | 37  |                                                                                                    |                                                                                            | 36  |                                                                                                    |
|                                                                                            | 38  | // Function to assign a job to a worker                                                            |                                                                                            | 37  | // Function to assign a job to a worker                                                            |
|                                                                                            | 39  | assignJob := func(worker string, jobType JobType, jobNumber int, numOtherPhase int, file string) { |                                                                                            | 38  | assignJob := func(worker string, jobType JobType, jobNumber int, numOtherPhase int, file string) { |
|                                                                                            | 40  | args := DoJobArgs{                                                                                 |                                                                                            | 39  | args := DoJobArgs{                                                                                 |
|                                                                                            | 41  | File:          file,                                                                               |                                                                                            | 40  | File:          file,                                                                               |
|                                                                                            | 42  | Operation:     jobType,                                                                            |                                                                                            | 41  | Operation:     jobType,                                                                            |
|                                                                                            | 43  | JobNumber:     jobNumber,                                                                          |                                                                                            | 42  | JobNumber:     jobNumber,                                                                          |
|                                                                                            | 44  | NumOtherPhase: numOtherPhase,                                                                      |                                                                                            | 43  | NumOtherPhase: numOtherPhase,                                                                      |
|                                                                                            | 45  | }                                                                                                  |                                                                                            | 44  | }                                                                                                  |
|                                                                                            | 46  | var reply DoJobReply                                                                               |                                                                                            | 45  | var reply DoJobReply                                                                               |
|                                                                                            | 47  |                                                                                                    |                                                                                            | 46  |                                                                                                    |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_3) | 48  | //go func() {                                                                                      | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_3) | 47  | // Call the worker to do the job                                                                   |
|                                                                                            | 49  | call(worker, "Worker.DoJob", &args, &reply)                                                        |                                                                                            | 48  | call(worker, "Worker.DoJob", &args, &reply)                                                        |
|                                                                                            | 50  | fmt.Printf("worker reply: %v\n", reply.OK)                                                         |                                                                                            | 49  | fmt.Printf("worker reply: %v\n", reply.OK)                                                         |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_4) | 51  | //}()                                                                                              | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_4) |     |                                                                                                    |
|                                                                                            | 52  | }                                                                                                  |                                                                                            | 50  | }                                                                                                  |
|                                                                                            | 53  |                                                                                                    |                                                                                            | 51  |                                                                                                    |
|                                                                                            | 54  | // Distribute map jobs to workers                                                                  |                                                                                            | 52  | // Distribute map jobs to workers                                                                  |
|                                                                                            | 55  | for i := 0; i < mr.nMap; i++ {                                                                     |                                                                                            | 53  | for i := 0; i < mr.nMap; i++ {                                                                     |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_5) | 56  | worker := <-workerChannel //POPs worker from worker channel                                        | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_5) | 54  | worker := <-workerChannel // POPs worker from worker channel                                       |
|                                                                                            | 57  | fmt.Printf("assigning worker %v a job\n", i)                                                       |                                                                                            | 55  | fmt.Printf("assigning worker %v a job\n", i)                                                       |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_6) |     |                                                                                                    | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_6) | 56  |                                                                                                    |
|                                                                                            |     |                                                                                                    |                                                                                            | 57  | // Assign job and put the worker back in the channel after completion                              |
|                                                                                            |     |                                                                                                    |                                                                                            | 58  | go func(worker string, i int) {                                                                    |
|                                                                                            | 58  | assignJob(worker, Map, i, mr.nReduce, mr.file)                                                     |                                                                                            | 59  | assignJob(worker, Map, i, mr.nReduce, mr.file)                                                     |
|                                                                                            | 59  | fmt.Println("done")                                                                                |                                                                                            | 60  | fmt.Println("done")                                                                                |
|                                                                                            | 60  | //workerChannel <- worker                                                                          |                                                                                            | 61  | workerChannel <- worker // Re-add worker to the channel                                            |
|                                                                                            |     |                                                                                                    |                                                                                            | 62  | }(worker, i)                                                                                       |
|                                                                                            | 61  | }                                                                                                  |                                                                                            | 63  | }                                                                                                  |
|                                                                                            | 62  |                                                                                                    |                                                                                            | 64  |                                                                                                    |
| [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_7) |     |                                                                                                    | [<br><br>n<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_difference_7) | 65  | // Wait for all jobs to be done (you can implement a wait mechanism)                               |
|                                                                                            |     |                                                                                                    |                                                                                            | 66  | // For now, we're just killing workers after all jobs are done.                                    |
|                                                                                            | 63  | fmt.Println("all map jobs done")                                                                   |                                                                                            | 67  | fmt.Println("all map jobs done")                                                                   |
|                                                                                            | 64  |                                                                                                    |                                                                                            | 68  |                                                                                                    |
|                                                                                            | 65  | return mr.KillWorkers()                                                                            |                                                                                            | 69  | return mr.KillWorkers()                                                                            |
| [<br><br>t<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_top)          | 66  | }                                                                                                  | [<br><br>t<br><br>](https://mail.google.com/mail/u/0/#m_-3774365751875697129_top)          | 70  | }                                                                                                  |
|                                                                                            |     |                                                                                                    |                                                                                            | 71  |                                                                                                    |